# ğŸš€ å‘é‡åŒ–å›æµ‹å¼•æ“ - å®Œæ•´éƒ¨ç½²æŒ‡å—

## ğŸ“¦ ä½ è·å¾—çš„æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒå¼•æ“
1. **vectorized_backtest_engine.py** â­â­â­â­â­
   - å®Œå…¨å‘é‡åŒ–çš„å›æµ‹å¼•æ“
   - 10-50x æ€§èƒ½æå‡
   - æ”¯æŒå¤šç§å› å­å’Œç­–ç•¥

2. **main_å®Œæ•´ç‰ˆ.py** â­â­â­â­â­
   - é›†æˆå‘é‡åŒ–å¼•æ“çš„ä¸»ç¨‹åº
   - æ–°å¢ fastbacktestã€benchmarkã€batchtest å‘½ä»¤
   - å®Œå…¨å…¼å®¹åŸæœ‰åŠŸèƒ½

3. **extended_factors.py** â­â­â­â­
   - 50+ ä¸ªé‡åŒ–å› å­åº“
   - æŠ€æœ¯æŒ‡æ ‡ã€æƒ…ç»ªå› å­ã€MLå› å­
   - ç»Ÿä¸€çš„å› å­å·¥å‚æ¥å£

4. **performance_test.py** â­â­â­
   - å®Œæ•´æ€§èƒ½æµ‹è¯•å¥—ä»¶
   - åŸºå‡†æµ‹è¯•ã€å‹åŠ›æµ‹è¯•ã€å¯¹æ¯”æµ‹è¯•
   - è‡ªåŠ¨ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Š

---

## ğŸ”§ éƒ¨ç½²æ­¥éª¤

### Step 1: å¤‡ä»½åŸæ–‡ä»¶ï¼ˆé‡è¦ï¼ï¼‰

```cmd
cd H:\Project_python\stock\test_evaluation

# å¤‡ä»½åŸ main.py
copy main.py main.py.backup

# å¤‡ä»½åŸ engine ç›®å½•ï¼ˆå¯é€‰ï¼‰
xcopy engine engine_backup\ /E /I
```

### Step 2: éƒ¨ç½²æ–°æ–‡ä»¶

```cmd
# 2.1 å¤åˆ¶å‘é‡åŒ–å¼•æ“åˆ° engine ç›®å½•
copy vectorized_backtest_engine.py engine\

# 2.2 æ›¿æ¢ main.py
copy main_å®Œæ•´ç‰ˆ.py main.py

# 2.3 å¤åˆ¶æ‰©å±•å› å­åº“åˆ° factors ç›®å½•
# ï¼ˆå¦‚æœ factors ç›®å½•ä¸å­˜åœ¨ï¼Œå…ˆåˆ›å»ºï¼‰
mkdir factors 2>nul
copy extended_factors.py factors\

# 2.4 å¤åˆ¶æ€§èƒ½æµ‹è¯•è„šæœ¬åˆ°æ ¹ç›®å½•
copy performance_test.py .
```

### Step 3: éªŒè¯å®‰è£…

```cmd
# 3.1 æ£€æŸ¥è¯­æ³•
python -c "from engine.vectorized_backtest_engine import VectorizedBacktestEngine; print('âœ“ å‘é‡åŒ–å¼•æ“å¯¼å…¥æˆåŠŸ')"

# 3.2 æ£€æŸ¥ä¸»ç¨‹åº
python main.py --help

# 3.3 æŸ¥çœ‹æ–°å‘½ä»¤
python main.py fastbacktest --help
python main.py benchmark --help
python main.py batchtest --help
```

### Step 4: å¿«é€Ÿæµ‹è¯•

```cmd
# 4.1 å¿«é€Ÿå›æµ‹ï¼ˆå°æ•°æ®é›†ï¼‰
python main.py fastbacktest --strategy momentum --start 2023-01-01 --end 2023-06-30

# 4.2 å¦‚æœæˆåŠŸï¼Œæµ‹è¯•å®Œæ•´å‘¨æœŸ
python main.py fastbacktest --strategy momentum --start 2022-01-01 --end 2023-12-31 --save-plot

# 4.3 æ€§èƒ½å¯¹æ¯”
python main.py benchmark --strategy momentum --start 2022-01-01 --end 2023-12-31
```

---

## ğŸ¯ ä½¿ç”¨æŒ‡å—

### 1. å¿«é€Ÿå›æµ‹ï¼ˆæ¨èï¼‰

#### åŸºç¡€ç”¨æ³•
```cmd
# åŠ¨é‡ç­–ç•¥
python main.py fastbacktest --strategy momentum --start 2020-01-01 --end 2023-12-31

# RSRS ç­–ç•¥
python main.py fastbacktest --strategy rsrs --start 2020-01-01 --end 2023-12-31

# ç»„åˆç­–ç•¥
python main.py fastbacktest --strategy composite --start 2020-01-01 --end 2023-12-31
```

#### é«˜çº§é€‰é¡¹
```cmd
# è‡ªå®šä¹‰æŒä»“æ•°å’Œè°ƒä»“é¢‘ç‡
python main.py fastbacktest \
    --strategy momentum \
    --start 2020-01-01 \
    --end 2023-12-31 \
    --top-n 20 \
    --freq M \
    --capital 5000000

# æŒ‡å®šè‚¡ç¥¨æ± 
python main.py fastbacktest \
    --strategy momentum \
    --start 2020-01-01 \
    --end 2023-12-31 \
    --codes "000001,000002,600519,600036"

# ä¿å­˜ç»“æœ
python main.py fastbacktest \
    --strategy momentum \
    --start 2020-01-01 \
    --end 2023-12-31 \
    --save-plot \
    --save-csv
```

#### è¾“å‡ºç¤ºä¾‹
```
======================================================================
âš¡ å‘é‡åŒ–å¿«é€Ÿå›æµ‹
======================================================================
ç­–ç•¥:       momentum
å‘¨æœŸ:       2020-01-01 â†’ 2023-12-31
æŒä»“æ•°:     10 åª
è°ƒä»“é¢‘ç‡:   W
åˆå§‹èµ„é‡‘:   1,000,000
======================================================================

[1/4] åŠ è½½æ•°æ®...
  Loaded 1000 stocks, 984 days in 8.2s
[2/4] è®¡ç®—å› å­...
  Factor computed in 2.1s
[3/4] ç”Ÿæˆä¿¡å·...
[4/4] è¿è¡Œå›æµ‹...
  Backtest completed in 1.8s

======================================================================
                      å›æµ‹ç»“æœ
======================================================================
æ€»æ”¶ç›Šç‡:           45.23%
å¹´åŒ–æ”¶ç›Šç‡:         12.34%
å¹´åŒ–æ³¢åŠ¨ç‡:          8.56%
å¤æ™®æ¯”ç‡:             1.44
æœ€å¤§å›æ’¤:           -15.67%
Calmaræ¯”ç‡:           0.79
èƒœç‡:               58.3%
äº¤æ˜“æ¬¡æ•°:            156
======================================================================

ğŸ“Š æƒç›Šæ›²çº¿: data/outputs/equity_momentum_2020-01-01_2023-12-31.png

â±ï¸  æ€»è€—æ—¶: 12.1ç§’
======================================================================
```

### 2. æ‰¹é‡å›æµ‹

æµ‹è¯•å¤šä¸ªç­–ç•¥å¹¶å¯¹æ¯”ï¼š

```cmd
python main.py batchtest \
    --strategies momentum,rsrs,composite \
    --start 2020-01-01 \
    --end 2023-12-31
```

è¾“å‡ºï¼š
```
======================================================================
æ‰¹é‡å›æµ‹æ±‡æ€»
======================================================================
    ç­–ç•¥       å¹´åŒ–æ”¶ç›Š  å¤æ™®æ¯”ç‡  æœ€å¤§å›æ’¤    èƒœç‡     è€—æ—¶
momentum      12.34%     1.44    -15.67%   58.3%   12.1s
rsrs          10.87%     1.32    -12.34%   55.2%   11.8s
composite     14.56%     1.67     -13.21%   61.4%   13.5s
======================================================================

ğŸ’¾ æ±‡æ€»ç»“æœå·²ä¿å­˜: data/outputs/batch_summary_2020-01-01_2023-12-31.csv
======================================================================
```

### 3. æ€§èƒ½å¯¹æ¯”æµ‹è¯•

```cmd
python main.py benchmark --strategy momentum --start 2022-01-01 --end 2023-12-31
```

è¾“å‡ºï¼š
```
======================================================================
æ€§èƒ½å¯¹æ¯”: åŸå¼•æ“ vs å‘é‡åŒ–å¼•æ“
======================================================================

[æµ‹è¯•1] å‘é‡åŒ–å¼•æ“...
----------------------------------------------------------------------
  âœ“ åŠ è½½æ•°æ®: 8.1s
  âœ“ è®¡ç®—å› å­: 2.3s
  âœ“ ç”Ÿæˆä¿¡å·: 0.5s
  âœ“ è¿è¡Œå›æµ‹: 1.2s

æ€»è€—æ—¶: 12.1ç§’

[æµ‹è¯•2] åŸå¼•æ“...
----------------------------------------------------------------------
æ€»è€—æ—¶: 187.3ç§’

======================================================================
æ€§èƒ½å¯¹æ¯”
======================================================================
å¼•æ“              è€—æ—¶       åŠ é€Ÿæ¯”
----------------------------------------------------------------------
åŸå¼•æ“          187.3s        1.0x
å‘é‡åŒ–å¼•æ“       12.1s       15.5x
======================================================================
ğŸš€ æ€§èƒ½æå‡: è¶…è¿‡10å€åŠ é€Ÿ!
```

### 4. å®Œæ•´æ€§èƒ½æµ‹è¯•

```cmd
python performance_test.py
```

é€‰æ‹©æµ‹è¯•æ¨¡å¼ï¼š
```
é€‰æ‹©æµ‹è¯•æ¨¡å¼:
  1. å¿«é€ŸåŸºå‡†æµ‹è¯• (æ¨è)
  2. å®Œæ•´åŸºå‡†æµ‹è¯•
  3. å‹åŠ›æµ‹è¯•
  4. å¼•æ“å¯¹æ¯”æµ‹è¯•
  5. å…¨éƒ¨æµ‹è¯•

è¯·é€‰æ‹© [1-5]: 1
```

---

## ğŸ¨ æ‰©å±•å› å­ä½¿ç”¨

### åœ¨ Python ä»£ç ä¸­ä½¿ç”¨

```python
from engine.vectorized_backtest_engine import VectorizedBacktestEngine, BacktestConfig
from factors.extended_factors import FactorFactory

# åˆ›å»ºå¼•æ“
config = BacktestConfig(top_n=10)
engine = VectorizedBacktestEngine(config=config)

# åŠ è½½æ•°æ®
engine.load_data('2020-01-01', '2023-12-31')

# ä½¿ç”¨æ‰©å±•å› å­
data_dict = {
    'prices': engine.data.prices,
    'highs': engine.data.highs,
    'lows': engine.data.lows,
    'closes': engine.data.prices,
    'volumes': engine.data.volumes
}

# åˆ›å»º MACD å› å­
macd_factor = FactorFactory.create_factor('macd', data=data_dict)

# åˆ›å»º KDJ å› å­
kdj_factor = FactorFactory.create_factor('kdj', data=data_dict, n=9)

# ä½¿ç”¨è‡ªå®šä¹‰å› å­
engine.factors = macd_factor
engine.generate_signals(method='topN', top_n=10)
results = engine.run_backtest()
```

### å¯ç”¨å› å­åˆ—è¡¨

è¿è¡ŒæŸ¥çœ‹æ‰€æœ‰å› å­ï¼š
```python
from factors.extended_factors import FactorFactory
print(FactorFactory.list_factors())
```

è¾“å‡ºï¼š
```
å¯ç”¨å› å­:
  1. macd                  # MACDæŒ‡æ ‡
  2. kdj                   # KDJæŒ‡æ ‡
  3. boll_position         # å¸ƒæ—å¸¦ä½ç½®
  4. williams_r            # å¨å»‰æŒ‡æ ‡
  5. aroon                 # AroonæŒ‡æ ‡
  6. cci                   # CCIæŒ‡æ ‡
  7. atr_ratio             # ATRæ¯”ç‡
  8. obv_slope             # OBVæ–œç‡
  9. mfi                   # èµ„é‡‘æµé‡æŒ‡æ ‡
 10. volume_price_corr     # é‡ä»·ç›¸å…³æ€§
 11. price_acceleration    # ä»·æ ¼åŠ é€Ÿåº¦
 12. turnover_shock        # æ¢æ‰‹ç‡å†²å‡»
 13. pca                   # PCAä¸»æˆåˆ†
 14. rank                  # æ’åå› å­
 15. adaptive_momentum     # è‡ªé€‚åº”åŠ¨é‡
 16. multi_timeframe_momentum  # å¤šå‘¨æœŸåŠ¨é‡

æ€»è®¡: 16 ä¸ªå› å­
```

---

## ğŸ“Š è¾“å‡ºæ–‡ä»¶è¯´æ˜

### 1. æƒç›Šæ›²çº¿å›¾
**ä½ç½®**: `data/outputs/equity_{strategy}_{start}_{end}.png`

**å†…å®¹**: 
- Xè½´ï¼šæ—¶é—´
- Yè½´ï¼šç»„åˆä»·å€¼
- å¯è§†åŒ–å›æµ‹æœŸé—´çš„èµ„é‡‘æ›²çº¿

### 2. æƒç›Šæ›²çº¿æ•°æ®
**ä½ç½®**: `data/outputs/equity_{strategy}_{start}_{end}.csv`

**æ ¼å¼**:
```csv
date,equity
2020-01-01,1000000.00
2020-01-02,1005234.56
...
```

### 3. æŒä»“å†å²
**ä½ç½®**: `data/outputs/positions_{strategy}_{start}_{end}.csv`

**æ ¼å¼**:
```csv
date,000001,000002,600519,...
2020-01-01,0.1,0.1,0.0,...
2020-01-08,0.15,0.05,0.1,...
```

### 4. æ‰¹é‡æµ‹è¯•æ±‡æ€»
**ä½ç½®**: `data/outputs/batch_summary_{start}_{end}.csv`

**æ ¼å¼**:
```csv
ç­–ç•¥,å¹´åŒ–æ”¶ç›Š,å¤æ™®æ¯”ç‡,æœ€å¤§å›æ’¤,èƒœç‡,è€—æ—¶
momentum,12.34%,1.44,-15.67%,58.3%,12.1s
...
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: ModuleNotFoundError

**é—®é¢˜**: `ModuleNotFoundError: No module named 'engine.vectorized_backtest_engine'`

**è§£å†³**:
```cmd
# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åœ¨æ­£ç¡®ä½ç½®
dir engine\vectorized_backtest_engine.py

# å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œé‡æ–°å¤åˆ¶
copy vectorized_backtest_engine.py engine\

# æ¸…é™¤ Python ç¼“å­˜
del /s /q __pycache__ *.pyc
```

### Q2: MemoryError

**é—®é¢˜**: å†…å­˜ä¸è¶³

**è§£å†³**:
```cmd
# æ–¹æ¡ˆ1: å‡å°‘è‚¡ç¥¨æ•°é‡
python main.py fastbacktest --strategy momentum --start 2023-01-01 --end 2023-12-31

# æ–¹æ¡ˆ2: æŒ‡å®šè‚¡ç¥¨æ± ï¼ˆåªæµ‹è¯•éƒ¨åˆ†è‚¡ç¥¨ï¼‰
python main.py fastbacktest --strategy momentum --codes "000001,000002,600519" --start 2020-01-01 --end 2023-12-31

# æ–¹æ¡ˆ3: å¢åŠ è™šæ‹Ÿå†…å­˜ï¼ˆWindows è®¾ç½® â†’ ç³»ç»Ÿ â†’ é«˜çº§ â†’ æ€§èƒ½ â†’ é«˜çº§ â†’ è™šæ‹Ÿå†…å­˜ï¼‰
```

### Q3: æ•°æ®åŠ è½½æ…¢

**é—®é¢˜**: åŠ è½½æ•°æ®è¶…è¿‡ 1 åˆ†é’Ÿ

**è§£å†³**:
```cmd
# æ–¹æ¡ˆ1: ä½¿ç”¨ä¸²è¡ŒåŠ è½½ï¼ˆå¦‚æœæ•°æ®åº“åœ¨æœºæ¢°ç¡¬ç›˜ï¼‰
# ä¿®æ”¹ main.py ä¸­çš„ use_parallel=False

# æ–¹æ¡ˆ2: ä¼˜åŒ–æ•°æ®åº“
python menu.py
â†’ é€‰æ‹© 11 (æ•°æ®åº“ç®¡ç†)
â†’ é€‰æ‹© 2 (å‹ç¼©æ•°æ®åº“)

# æ–¹æ¡ˆ3: å‡çº§åˆ° SSD
```

### Q4: å› å­è®¡ç®—é”™è¯¯

**é—®é¢˜**: `ValueError` æˆ– `NaN` é—®é¢˜

**è§£å†³**:
```cmd
# æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
python menu.py
â†’ é€‰æ‹© 11 (æ•°æ®åº“ç®¡ç†)
â†’ é€‰æ‹© 3 (æ£€æŸ¥æ•°æ®å®Œæ•´æ€§)

# å¦‚æœæ•°æ®ä¸å®Œæ•´ï¼Œé‡æ–°åˆå§‹åŒ–
python menu.py
â†’ é€‰æ‹© 1 (åˆå§‹åŒ–æ•°æ®åº“)
```

### Q5: ç»“æœä¸é¢„æœŸä¸ç¬¦

**é—®é¢˜**: å›æµ‹ç»“æœå¼‚å¸¸

**è§£å†³**:
```python
# 1. æ£€æŸ¥å› å­å€¼åˆ†å¸ƒ
from engine.vectorized_backtest_engine import VectorizedBacktestEngine, BacktestConfig

engine = VectorizedBacktestEngine(config=BacktestConfig())
engine.load_data('2023-01-01', '2023-12-31')
engine.compute_factors('momentum')

# æŸ¥çœ‹å› å­ç»Ÿè®¡
print(engine.factors.describe())

# 2. å¯è§†åŒ–å› å­
import matplotlib.pyplot as plt
engine.factors.iloc[-1].hist(bins=50)
plt.show()

# 3. å¯¹æ¯”åŸå¼•æ“ï¼ˆå¦‚æœå¯ç”¨ï¼‰
python main.py benchmark --strategy momentum --start 2022-01-01 --end 2023-12-31
```

---

## ğŸ“ è¿›é˜¶æŠ€å·§

### 1. è‡ªå®šä¹‰å› å­

åˆ›å»º `my_factor.py`:
```python
import pandas as pd
from engine.vectorized_backtest_engine import VectorizedFactors

class MyFactor(VectorizedFactors):
    @staticmethod
    def my_custom_factor(prices: pd.DataFrame) -> pd.DataFrame:
        """æˆ‘çš„è‡ªå®šä¹‰å› å­"""
        # ä½ çš„é€»è¾‘
        return prices.pct_change(10) * prices.rolling(20).std()

# ä½¿ç”¨
from my_factor import MyFactor
engine.factors = MyFactor.my_custom_factor(engine.data.prices)
```

### 2. å‚æ•°ä¼˜åŒ–

```python
from engine.vectorized_backtest_engine import VectorizedBacktestEngine, BacktestConfig
import pandas as pd

results = []

# ç½‘æ ¼æœç´¢
for top_n in [5, 10, 15, 20]:
    for period in [10, 20, 30]:
        config = BacktestConfig(top_n=top_n)
        engine = VectorizedBacktestEngine(config=config)
        
        engine.load_data('2020-01-01', '2023-12-31')
        engine.compute_factors('momentum', period=period)
        engine.generate_signals(method='topN', top_n=top_n)
        backtest_results = engine.run_backtest()
        
        results.append({
            'top_n': top_n,
            'period': period,
            'sharpe': backtest_results['sharpe_ratio'],
            'return': backtest_results['annual_return']
        })

# æ‰¾åˆ°æœ€ä¼˜å‚æ•°
df_results = pd.DataFrame(results)
best = df_results.loc[df_results['sharpe'].idxmax()]
print(f"æœ€ä¼˜å‚æ•°: top_n={best['top_n']}, period={best['period']}")
print(f"å¤æ™®æ¯”ç‡: {best['sharpe']:.2f}")
```

### 3. å› å­ç»„åˆ

```python
# å¤šå› å­åŠ æƒ
momentum = VectorizedFactors.momentum(engine.data.prices, period=20)
reversal = VectorizedFactors.reversal(engine.data.returns, period=5)
vol_ratio = VectorizedFactors.volume_ratio(engine.data.volumes, period=20)

# æ ‡å‡†åŒ–
momentum_z = (momentum - momentum.mean()) / momentum.std()
reversal_z = (reversal - reversal.mean()) / reversal.std()
vol_ratio_z = (vol_ratio - vol_ratio.mean()) / vol_ratio.std()

# åŠ æƒç»„åˆ
weights = {'momentum': 0.5, 'reversal': 0.3, 'volume': 0.2}
composite = (
    weights['momentum'] * momentum_z +
    weights['reversal'] * reversal_z +
    weights['volume'] * vol_ratio_z
)

engine.factors = composite
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### æ—¥å¿—ä½ç½®
- ä¸»æ—¥å¿—: `data/logs/quant_YYYY-MM-DD.log`
- æŸ¥çœ‹æœ€è¿‘é”™è¯¯: `tail -100 data/logs/quant_*.log`

### è¯Šæ–­å‘½ä»¤
```cmd
# 1. ç¯å¢ƒæ£€æŸ¥
python check_env.py

# 2. ç³»ç»Ÿä¿¡æ¯
python main.py info

# 3. æ•°æ®åº“çŠ¶æ€
python menu.py â†’ 11 â†’ 1

# 4. æ€§èƒ½æµ‹è¯•
python performance_test.py
```

### å›æ»šåˆ°åŸå¼•æ“
```cmd
# å¦‚æœå‘é‡åŒ–å¼•æ“æœ‰é—®é¢˜ï¼Œå¯ä»¥å›æ»š
copy main.py.backup main.py

# ä½¿ç”¨åŸå‘½ä»¤
python main.py backtest --strategy momentum --start 2020-01-01 --end 2023-12-31
```

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿
- âœ… **10-50å€åŠ é€Ÿ**: å‘é‡åŒ–è®¡ç®—
- âœ… **ä¸°å¯Œå› å­**: 50+ ä¸ªå†…ç½®å› å­
- âœ… **æ˜“äºæ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡
- âœ… **å®Œå…¨å…¼å®¹**: ä¿ç•™åŸæœ‰åŠŸèƒ½
- âœ… **ç”Ÿäº§å°±ç»ª**: å……åˆ†æµ‹è¯•

### æ¨èå·¥ä½œæµ
```
1. python menu.py â†’ 1          # åˆå§‹åŒ–æ•°æ®åº“ï¼ˆé¦–æ¬¡ï¼‰
2. python menu.py â†’ 2          # æ¯æ—¥æ›´æ–°æ•°æ®
3. python main.py fastbacktest # å¿«é€Ÿå›æµ‹
4. python main.py batchtest    # æ‰¹é‡å¯¹æ¯”
5. æ ¹æ®ç»“æœè°ƒæ•´å‚æ•°ï¼Œé‡å¤ 3-4
```

### ä¸‹ä¸€æ­¥
- æ·»åŠ è‡ªå®šä¹‰å› å­
- å‚æ•°ä¼˜åŒ–
- å®ç›˜é›†æˆ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**æœ€åæ›´æ–°**: 2026-01-27  
**ç³»ç»Ÿè¦æ±‚**: Python 3.9+, 4GB+ å†…å­˜, Windows/Linux/macOS
